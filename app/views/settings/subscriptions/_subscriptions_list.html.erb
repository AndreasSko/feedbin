<div data-behavior="subscriptions_list">
    <%= form_tag update_multiple_settings_subscriptions_path, method: :patch, autocomplete: 'off' do |update_form| %>
        <%= hidden_field_tag :q, params[:q] %>


        <div class="p-4 flex border rounded-t-lg items-baseline justify-between">
          <div class="checkbox">
            <input type="checkbox" class="feeds-checkbox" data-behavior="toggle_checked" id="select_all_feeds" />
            <label for="select_all_feeds"><%= svg_tag "icon-check" %>Select all</label>
          </div>

          <div class="max-w-[250px]">
            <%= component "settings/select_input" do |input| %>
              <% input.input do %>
                <%= select_tag :operation, options_for_select([["Actions", nil], ["Unsubscribe", "unsubscribe"], ["Show edits on articles", "show_updates"], ["Hide edits on articles", "hide_updates"], ["Mute Feed", "mute"], ["Unmute Feed", "unmute"]]), class: "peer", disabled: true, data: {behavior: "feed_actions enable_control_target"} %>
              <% end %>
              <% input.accessory_trailing position: "trailing" do %>
                <%= svg_tag "icon-caret", class: "fill-400 pg-focus:fill-blue-600 pg-disabled:fill-200" %>
              <% end %>
            <% end %>
          </div>
        </div>
        <% if @subscriptions.total_entries > @subscriptions.count  %>
            <div class="border border-t-0 py-2 px-4 hide" data-behavior="toggle_checked_hidden">
                <div class="checkbox">
                    <%= check_box_tag "include_all", 1, false, data: {behavior: "include_all"}, id: "include_all_feeds" %>
                    <label for="include_all_feeds">
                        <%= svg_tag "icon-check" %>
                        <% if params[:q] %>
                            Include all <%= number_with_delimiter(@subscriptions.total_entries) %> <%= "feed".pluralize(@subscriptions.total_entries) %> matching this search.
                        <% else %>
                            Include all <%= number_with_delimiter(@subscriptions.total_entries) %> <%= "feed".pluralize(@subscriptions.total_entries) %>.
                        <% end %>
                    </label>
                </div>
            </div>
        <% end %>

        <ul>
          <% @subscriptions.each do |subscription| %>
            <% present subscription do |subscription_presenter| %>
              <%= fields_for "subscriptions[]", subscription do |f| %>
                <li class="flex items-center relative border-b border-x gap-2">

                  <div class="shrink-0 w-[40px] self-stretch">
                      <%= check_box_tag "subscription_ids[]", subscription.id, false, id: "subscription_checkbox_#{subscription.id}", class: "peer", data: {behavior: "enable_control"} %>
                      <label class="group" for="<%= "subscription_checkbox_#{subscription.id}" %>">

                        <%=
                        container = %w[
                          w-[16px] h-[16px] flex bg-200 rounded-[3px] relative border-2 border-400
                          pg-checked:bg-green-600 pg-checked:border-green-600
                          pg-active:bg-300 pg-active:border-500
                          pg-checked:pg-active:bg-transparent pg-checked:pg-active:border-green-600
                        ]

                        ring = %w[
                          absolute flex items-center justify-center -translate-x-1/2 -translate-y-1/2
                          left-1/2 top-1/2 w-[26px] h-[26px] rounded-[8px] border-4 border-transparent
                          pg-focus:border-blue-400
                        ]

                        check = %w[
                          fill-transparent pg-checked:fill-white
                        ]

                        content_tag :span, class: container do
                          content_tag :span, class: ring do
                            svg_tag "icon-check", class: check
                          end
                        end

                        %>

                      </label>
                  </div>

                  <%= link_to edit_settings_subscription_path(subscription), class: "flex grow items-center overflow-hidden gap-2 px-4 py-3" do %>
                    <span class="self-start block">
                      <%= subscription_presenter.favicon(subscription.feed) %>
                    </span>

                    <span>
                      <span class="block truncate">
                        <%= subscription.title %>
                      </span>
                      <span class="block truncate">
                        <%= short_url(subscription.feed_url) %>
                      </span>
                    </span>

                    <span class="ml-auto flex items-center">
                      <%= render partial: "shared/sparkline", locals: {sparkline: subscription_presenter.sparkline} %>
                      <%= svg_tag "icon-caret", class: "fill-300 -rotate-90" %>
                    </span>
                  <% end %>
                </li>
              <% end %>
            <% end %>
          <% end %>
        </ul>

        <ul class="pill-list feed-form"  data-behavior="search_results toggle_checked_target">
            <% @subscriptions.each do |subscription| %>
                <% present subscription do |subscription_presenter| %>
                    <%= fields_for "subscriptions[]", subscription do |f| %>
                        <li class="feeds-wrap <%= subscription_presenter.mute_class %>">
                            <i class="status-flag icon-muted"></i>

                            <div class="checkbox">
                                <%= check_box_tag "subscription_ids[]", subscription.id, false, id: "subscription_checkbox_#{subscription.id}", data: {behavior: "enable_control"} %>
                                <label for="<%= "subscription_checkbox_#{subscription.id}" %>"><%= svg_tag "icon-check" %></label>
                            </div>

                            <%= link_to edit_settings_subscription_path(subscription), class: "subscription-link" do %>
                                <span class="subscription-data-wrap">
                                    <span class="subscription-data">
                                        <span class="favicon-container">
                                            <%= subscription_presenter.favicon(subscription.feed) %>
                                        </span>
                                        <span class="text-wrap">
                                            <span class="title-container">
                                                <%= subscription.title %>
                                            </span>
                                            <span class="last-updated-wrap">
                                                <%= timeago(subscription.last_published_entry) %>, <%= number_with_delimiter(subscription.post_volume) %>/mo
                                            </span>
                                        </span>
                                    </span>
                                    <span class="subscription-meta">
                                        <span class="feed-url-wrap">
                                            <%= short_url(subscription.feed_url) %>
                                        </span>
                                    </span>
                                </span>
                                <span class="subscription-controls">
                                    <%= render partial: "shared/sparkline", locals: {sparkline: subscription_presenter.sparkline} %>
                                    <span class="icon-wrap"><%= svg_tag "icon-caret" %></span>
                                </span>
                            <% end %>
                        </li>
                    <% end %>
                <% end %>
            <% end %>
        </ul>
    <% end %>
    <%= will_paginate @subscriptions, previous_label: "Previous", next_label: "Next" %>
</div>
