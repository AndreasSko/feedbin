var update = function() {
    var ids = <%= @entries.map{ |entry| entry.id }.to_json.html_safe %>;
    var header = "<%= j render partial: "entries/entries_header", locals: {feed: @feed || nil} %>";

    <% if @entries.length == 0 %>
        var entries = "<%= j render partial: "entries/no_entry" %>";
    <% else %>
        var entries = "<%= j render partial: "entries/entry", collection: @entries, cached: true %>";
    <% end %>

    <% if @append %>
        feedbin.appendEntries(entries, header);
    <% else %>
        feedbin.updateEntries(entries, header);
    <% end %>

    <% if @page_query %>
        feedbin.updatePager("<%= j will_paginate(@page_query) %>");
    <% else %>
        feedbin.updatePager("");
    <% end %>

    <% if @force_preload %>
        feedbin.preloadEntries(ids, true);
    <% else %>
        feedbin.preloadEntries(ids, false);
    <% end %>

    <% if @search %>
        feedbin.showSearchControls("<%= params[:sort] %>", "<%= @escaped_query %>", "<%= new_saved_search_path(query: params[:query]) %>", "Mark <%= number_with_delimiter(@total_results) %> <%= "article".pluralize(@total_results) %> that <%= "match".pluralize(@total_results == 1 ? 2 : 1) %> the search “<%= @escaped_query %>” as read?");
    <% else %>
        feedbin.hideSearch()
    <% end %>

    <% if @all_unread %>
        var unreads = <%= @entries.map {|entry| {id: entry.id, feed_id: entry.feed_id, published: entry.published.to_i}}.to_json.html_safe %>;
        feedbin.updateUnreads(<%= @all_unread ? 1 : 0 %>, unreads)
    <% end %>

    feedbin.formatEntries("<%= j view_mode %>", "<%= j last_unread_date %>", "<%= @type %>")
}

if (feedbin.panelScrollComplete) {
    update();
} else {
    var interval = setInterval(checkForCompletion, 10);
    function checkForCompletion() {
        if (feedbin.panelScrollComplete) {
            clearInterval(interval);
            update();
        }
    }
}
